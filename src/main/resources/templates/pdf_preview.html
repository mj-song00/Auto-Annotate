<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>PDF 미리보기</title>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // ✅ workerSrc 지정 (중요)
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
    </script>
</head>
<body>
<h1>PDF 미리보기</h1>
<div style="display:none" id="bundleDebug" th:text="${bundleKey}">NO_BUNDLEKEY ㅇㄹㄴㄹㅇㄴ</div>

<!-- ✅ 버튼은 "조건번호(1~4)"를 넘긴다 -->
<button type="button" onclick="openPdfModal(0)">동일 병원 7일 이상</button>
<button type="button" onclick="openPdfModal(1)">30일 초과 약제</button>
<button type="button" onclick="openPdfModal(2)">입원</button>
<button type="button" onclick="openPdfModal(3)">수술</button>

<div id="pdfModal" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:#fff; border:1px solid #ccc; padding:10px; overflow:auto;">
    <canvas id="pdfCanvas"></canvas>
    <div style="margin-top:10px;">
        <button id="prevPage">◀ 이전</button>
        <button id="nextPage">다음 ▶</button>
        <span>페이지: <span id="pageNum"></span> / <span id="pageCount"></span></span>
    </div>
    <div style="margin-top:10px;">
        <button onclick="downloadPdf()">다운로드</button>
        <button onclick="closePdfModal()">닫기</button>
    </div>
</div>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function() {
        let currentConditionNo = null;
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;

        const scale = 1.5;
        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext('2d');

        const bundleKey = /*[[${bundleKey}]]*/ "";
        console.log("bundleKey:", bundleKey);

        function resetViewerState() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('pageNum').textContent = "";
            document.getElementById('pageCount').textContent = "";
            pageNum = 1;
            pageRendering = false;
            pageNumPending = null;

            if (pdfDoc && typeof pdfDoc.destroy === "function") {
                pdfDoc.destroy();
            }
            pdfDoc = null;
        }

        window.openPdfModal = function(conditionNo) {
            console.log("openPdfModal called:", conditionNo, "bundleKey=", bundleKey);

            currentConditionNo = conditionNo;

            resetViewerState();

            const modal = document.getElementById('pdfModal');
            if (!modal) {
                console.error("pdfModal 엘리먼트가 없음. id='pdfModal' 확인");
                return;
            }

            modal.style.display = 'block';  //  먼저 모달을 연다

            if (!bundleKey) {
                console.error("bundleKey가 비어있음 (preview/{bundleKey}로 접속해야 함)");
                return; // 모달은 열린 채로 두고 에러만 표시
            }

            if (typeof pdfjsLib === "undefined") {
                console.error("pdfjsLib가 없음. PDF.js 스크립트 로드 확인");
                return;
            }

            const url = `/document/bundles/${bundleKey}/highlighted?condition=${currentConditionNo}`;
            console.log("요청 URL:", url);

            pdfjsLib.getDocument(url).promise
                .then(pdf => {
                    pdfDoc = pdf;
                    document.getElementById('pageCount').textContent = pdfDoc.numPages;
                    renderPage(pageNum);
                })
                .catch(err => console.error("PDF 로드 실패:", err));
        };


        function renderPage(num) {
            if (!pdfDoc) return;
            pageRendering = true;

            pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderTask = page.render({ canvasContext: ctx, viewport });

                renderTask.promise.then(() => {
                    pageRendering = false;
                    document.getElementById('pageNum').textContent = num;

                    if (pageNumPending !== null) {
                        const next = pageNumPending;
                        pageNumPending = null;
                        renderPage(next);
                    }
                });
            }).catch(err => {
                pageRendering = false;
                console.error("페이지 렌더링 실패:", err);
            });
        }

        function queueRenderPage(num) {
            if (pageRendering) pageNumPending = num;
            else renderPage(num);
        }

        document.getElementById('prevPage').addEventListener('click', () => {
            if (!pdfDoc || pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        });

        window.downloadPdf = function() {
            if (!bundleKey || !currentConditionNo) return;
            // 다운로드도 bundleKey 기반으로 맞추는 걸 추천
            const url = `/document/bundles/${bundleKey}/download?condition=${currentConditionNo}`;
            window.location.href = url;
        };

        window.closePdfModal = function() {
            document.getElementById('pdfModal').style.display = 'none';
            resetViewerState();
        };
    });
</script>
</body>
</html>
