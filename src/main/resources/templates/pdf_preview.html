<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>PDF 미리보기</title>

    <!-- PDF.js 전체 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

</head>
<body>
<h1>PDF 미리보기</h1>

<button onclick="openPdfModal(0)">조건 1</button>
<button onclick="openPdfModal(1)">조건 2</button>
<button onclick="openPdfModal(2)">조건 3</button>
<button onclick="openPdfModal(3)">조건 4</button>

<div id="pdfModal" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:#fff; border:1px solid #ccc; padding:10px; overflow:auto;">
    <canvas id="pdfCanvas"></canvas>
    <div style="margin-top:10px;">
        <button id="prevPage">◀ 이전</button>
        <button id="nextPage">다음 ▶</button>
        <span>페이지: <span id="pageNum"></span> / <span id="pageCount"></span></span>
    </div>
    <div style="margin-top:10px;">
        <button onclick="downloadPdf()">다운로드</button>
        <button onclick="closePdfModal()">닫기</button>
    </div>
</div>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function() {
        let currentButtonIndex = null;
        let currentDocumentId = null;
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        const scale = 1.5;
        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext('2d');

        let documentIds = /*[[${documentIds}]]*/ [];
        console.log(documentIds)

        window.openPdfModal = function(buttonIndex) {
            if (!documentIds || documentIds.length === 0) return;
            if (!documentIds[buttonIndex]) return;

            currentButtonIndex = buttonIndex;
            currentDocumentId = documentIds[buttonIndex];
            pageNum = 1;
            console.log(`요청 아이디 : ${currentDocumentId }`)
            document.getElementById('pdfModal').style.display = 'block';

            const url = '/document/' + currentDocumentId + '/highlighted?condition=' + currentButtonIndex;

            console.log("요청 URL:", url); // ✅ 디버그용

            pdfjsLib.getDocument(url).promise.then(pdf => {
                pdfDoc = pdf;
                document.getElementById('pageCount').textContent = pdfDoc.numPages;
                renderPage(pageNum);
            });
        }


        function renderPage(num) {
            pageRendering = true;
            pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale: scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderContext = { canvasContext: ctx, viewport: viewport };
                const renderTask = page.render(renderContext);

                renderTask.promise.then(() => {
                    pageRendering = false;
                    document.getElementById('pageNum').textContent = num;
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });
        }

        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        document.getElementById('prevPage').addEventListener('click', () => {
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        });

        window.downloadPdf = function() {
            if (!currentDocumentId) return;
            const url = '/pdf/' + currentDocumentId + '/download?button=' + currentButtonIndex;
            window.location.href = url;
        }

        window.closePdfModal = function() {
            document.getElementById('pdfModal').style.display = 'none';
        }
    });
</script>
</body>
</html>
